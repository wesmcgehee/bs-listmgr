/*
 *
 * Wijmo Library 1.2.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * licensing@wijmo.com
 * http://www.wijmo.com/license
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijdropdown",{options:{zIndex:1e3,showingAnimation:{effect:"blind"},hidingAnimation:{effect:"blind"}},hoverClass:"ui-state-hover",activeClass:"ui-state-active",focusClass:"ui-state-focus",_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);c==="disabled"&&this._labelWrap.toggleClass("ui-state-disabled",b)},_create:function(){var a=this,b=a.element;if(b.get(0).tagName.toLowerCase()!=="select")return;a._activeItem=null;a._createSelect();a._bindEvents()},_createSelect:function(){var b=this,c=b.element,m=c.width(),g=m,h=c.height(),k=c.wrap("<div></div>").parent().addClass("ui-helper-hidden"),l=k.wrap("<div></div>").parent().attr("role","select").addClass("wijmo-wijdropdown ui-widget ui-widwijmo-wijdropdownt-content ui-state-default ui-corner-all ui-helper-clearfix"),i=a('<label class="wijmo-dropdown-label ui-corner-all"></label>').attr("id",c.get(0).id+"_select").attr("name",c.attr("name")||""),j=a("<div></div>").addClass("wijmo-dropdown-trigger ui-state-default ui-corner-right"),f=a('<a href="#"></a>'),d=a("<div>").addClass("wijmo-dropdown"),e=a("<ul></ul>").addClass("wijmo-dropdown-list ui-widget-content ui-widget ui-corner-all ui-helper-reset").appendTo(d);a("<span></span>").addClass("ui-icon ui-icon-triangle-1-s").appendTo(j);m=Math.max(m,l.width());c.get(0).tabIndex!==""&&f.attr("tabindex",c.attr("tabindex"));if(c.get(0).disabled!==false){b.options.disabled=true;f.addClass("ui-state-disabled")}f.append(i);l.append(k).append(f).append(j).append(d);g+=parseInt(i.css("padding-left").replace(/px/,""));g+=parseInt(i.css("padding-right").replace(/px/,""));g-=16;l.width(g);c.children().each(function(i,h){var c=a(h),f,g,d;if(c.is("option"))e.append(b._buildItem(c));else{f=a('<li class="wijmo-dropdown-optgroup"></li>');g=a("<span>"+c.attr("label")+"</span>").addClass("wijmo-optgroup-header ui-priority-primary");d=a("<ul></ul>").addClass("ui-helper-reset wijmo-dropdown-items");c.children("option").each(function(){d.append(b._buildItem(a(this)))});f.append(g).append(d);e.append(f)}});h=d.height();h=e.outerHeight()<h?e.outerHeight():h;d.css({height:h,width:g});b.superpanel=d.wijsuperpanel().data("wijsuperpanel");a.fn.bgiframe&&b.superpanel.element.bgiframe();e.setOutWidth(e.parent().parent().innerWidth());d.hide();b._rightTrigger=j;b._label=i;b._listContainer=d;b._list=e;b._value=c.val();b._selectWrap=k;b._labelWrap=f},_handelEvents:function(d){var a=this,b="."+a.widgetName,c=a.element;d.bind("click"+b,function(b){if(a.options.disabled)return;if(a._listContainer.is(":hidden"))a._show();else a._hide();c.click();if(d.get(0)===a._label.get(0))b.preventDefault();else a._labelWrap.focus()}).bind("mouseover"+b,function(){if(a.options.disabled)return;a._label.addClass(a.hoverClass);a._rightTrigger.addClass(a.hoverClass);c.trigger("mouseover")}).bind("mouseout"+b,function(){if(a.options.disabled)return;a._label.removeClass(a.hoverClass);a._rightTrigger.removeClass(a.hoverClass);c.trigger("mouseout")}).bind("mousedown"+b,function(){if(a.options.disabled)return;a._label.addClass(a.activeClass);a._rightTrigger.addClass(a.activeClass);c.trigger("mousedown")}).bind("mouseup"+b,function(){if(a.options.disabled)return;a._label.removeClass(a.activeClass);a._rightTrigger.removeClass(a.activeClass);c.trigger("mouseup")})},_bindEvents:function(){var b=this,d="."+b.widgetName,h=b._label,g=b._rightTrigger,i=b._labelWrap,e=b._listContainer,c=b.element,f;b._handelEvents(b._label);b._handelEvents(b._rightTrigger);a(document.body).bind("click"+d,function(a){if(e.is(":hidden"))return;f=e.offset();if(a.target===h.get(0)||a.target===g.get(0)||a.target===g.children().get(0))return;(a.pageX<f.left||a.pageX>f.left+e.width()||a.pageY<f.top||a.pageY>f.top+e.height())&&b._hide()});e.bind("click"+d,function(f){var d=a(f.target);if(d.closest("li.wijmo-dropdown-item",a(this)).length>0){b._setValue();e.hide();b.oldVal=c.val();c.val(b._value);b.oldVal!==b._value&&c.trigger("change")}c.click()});i.bind("keydown"+d,function(e){if(b.options.disabled)return;var d=a.ui.keyCode;switch(e.which){case d.UP:case d.LEFT:b.previous();b._setValue();break;case d.DOWN:case d.RIGHT:b.next();b._setValue();break;case d.PAGE_DOWN:b.nextPage();b._setValue();break;case d.PAGE_UP:b.previousPage();b._setValue();break;case d.ENTER:case d.NUMPAD_ENTER:b._setValue();b._listContainer.hide();b.oldVal=c.val();c.val(b._value);b.oldVal!==b._value&&c.trigger("change")}e.which!==d.TAB&&e.preventDefault();c.trigger("keydown")}).bind("focus"+d,function(){if(b.options.disabled)return;h.addClass(b.focusClass);g.addClass(b.focusClass);c.focus()}).bind("blur"+d,function(){if(b.options.disabled)return;h.removeClass(b.focusClass);g.removeClass(b.focusClass);c.trigger("blur")}).bind("keypress"+d,function(){if(b.options.disabled)return;c.trigger("keypress")}).bind("keyup"+d,function(){if(b.options.disabled)return;c.trigger("keyup")})},_init:function(){var a=this;a._initActiveItem();a._activeItem&&a._label.text(a._activeItem.text())},_buildItem:function(d){var f=d.val(),b=d.text(),e=this,c;if(b==="")b="&nbsp;";c=a('<li class="wijmo-dropdown-item ui-corner-all"><span>'+b+"</span></li>").mousemove(function(b){var c=a(b.target).closest(".wijmo-dropdown-item");c!==this.last&&e._activate(a(this));this.last=a(b.target).closest(".wijmo-dropdown-item")}).attr("role","option");c.data("value",f);return c},_show:function(){var d=this,c=d._listContainer,b=d.options.showingAnimation;c.css("z-index","100000");a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)&&c.parent().css("z-index","99999");if(b)c.stop().show(b.effect,b.options,b.speed,function(){d._initActiveItem()});else c.show()},_hide:function(){var d=this,b=d._listContainer,c=d.options.hidingAnimation;if(b.is(":hidden"))return;if(c)b.stop(false,true).hide(c.effect,c.options,c.speed,function(){a.isFunction(c.callback)&&c.callback.apply(d,arguments);a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)&&b.parent().css("z-index","");b.css("z-index","")});else{a.browser.msie&&a.browser.version==="6.0"&&b.parent().css("z-index","");b.css("z-index","");b.hide()}},_setValue:function(){var a=this,b=a._listContainer,c,d;if(a._activeItem){a._label.text(a._activeItem.text());a._value=a._activeItem.data("value");if(a.superpanel.vNeedScrollBar){c=a._activeItem.offset().top;d=a._activeItem.outerHeight();if(b.offset().top>c)b.wijsuperpanel("scrollTo",0,c-a._list.offset().top);else b.offset().top<c+d-b.innerHeight()&&b.wijsuperpanel("scrollTo",0,c+d-b.height()-a._list.offset().top)}}},_initActiveItem:function(){var b=this;b._value!==undefined&&b._list.find("li.wijmo-dropdown-item").each(function(){a(this).data("value")===b._value&&b._activate(a(this))})},_activate:function(b){var a=this;a._deactivate();a._activeItem=b;a._activeItem.addClass(a.hoverClass).attr("aria-selected",true)},_deactivate:function(){var a=this;a._activeItem&&a._activeItem.removeClass(a.hoverClass).attr("aria-selected",false)},next:function(){this._move("next","first")},previous:function(){this._move("prev","last")},nextPage:function(){this._movePage("first")},previousPage:function(){this._movePage("last")},_move:function(c,d){var a=this,e,b;if(!a._activeItem){a._activate(a._list.find(".wijmo-dropdown-item:"+d));return}e=a._activeItem[c]().eq(0);if(e.length)b=a._getNextItem(e,c,d);else if(a._activeItem.closest(".wijmo-dropdown-optgroup").length)b=a._getNextItem(a._activeItem.closest(".wijmo-dropdown-optgroup")[c](),c,d);if(b&&b.length)a._activate(b);else a._activate(a._list.find(".wijmo-dropdown-item:"+d))},_movePage:function(d){var b=this,g,e,c,f=d==="first"?"last":"first";if(b.superpanel.vNeedScrollBar){g=b._activeItem.offset().top;e=b.options.height;c=b._list.find(".wijmo-dropdown-item").filter(function(){var c=a(this).offset().top-g+(d==="first"?-e:e)+a(this).height(),b=a(this).height();return c<b&&c>-b});if(!c.length)c=b._list.find(".wijmo-dropdown-item:"+f);b._activate(c)}else b._activate(b._list.find(".wijmo-dropdown-item:"+(!b._activeItem?d:f)))},_getNextItem:function(a,b,c){if(a.length)if(a.is(".wijmo-dropdown-optgroup"))if(!!a.find(">ul>li.wijmo-dropdown-item").length)return a.find(">ul>li.wijmo-dropdown-item:"+c).eq(0);else this._getNextItem(a[b]().eq(0));else return a},destroy:function(){this.element.closest(".wijmo-wijdropdown").find(">div.wijmo-dropdown-trigger,>div.wijmo-dropdown,>a").remove();this.element.unwrap().unwrap().removeData("maxZIndex");a.Widget.prototype.destroy.apply(this)}})})(jQuery);